<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Our Secret Space ‚ù§Ô∏è</title>
  <style>
    /* --- DESIGN & COLORS --- */
    body { margin: 0; background: #ece5dd; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    
    /* Login Screen */
    #lock { position: fixed; inset: 0; background: #fff; z-index: 99; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
    input.pass { padding: 15px; font-size: 18px; border-radius: 30px; border: 1px solid #ccc; text-align: center; margin-bottom: 15px; width: 80%; max-width: 300px; outline: none; }
    button.btn { padding: 12px 30px; background: #075e54; color: white; border: none; border-radius: 30px; font-size: 16px; cursor: pointer; font-weight: bold; }
    
    /* Chat Screen */
    #chat-wrap { display: none; flex-direction: column; height: 100%; max-width: 600px; margin: 0 auto; background: #e5ddd5; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); width: 100%; }
    
    header { background: #075e54; color: white; padding: 12px 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; z-index: 10; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .status-text { font-size: 12px; font-weight: normal; opacity: 0.9; display: block; margin-top: 2px;}
    
    #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 6px; scroll-behavior: smooth; }
    
    /* Bubble Styles - FIXED SPACING */
    .msg { 
      padding: 6px 10px; /* Tighter padding */
      border-radius: 7.5px; 
      max-width: 75%; 
      width: fit-content; 
      font-size: 15px; 
      position: relative; 
      box-shadow: 0 1px 1px rgba(0,0,0,0.1); 
      line-height: 1.3; 
      cursor: pointer; 
      user-select: none; 
      
      /* FLEX LAYOUT to kill ghost spaces */
      display: flex;
      flex-direction: column;
      align-items: flex-end; /* Aligns time to right */
    }
    
    /* The actual text inside the bubble */
    .msg-content {
      align-self: flex-start; /* Text aligns left */
      word-wrap: break-word; 
      word-break: break-word;
      white-space: pre-wrap; /* Allows your newlines */
      margin-bottom: 2px;
    }

    .msg:hover { opacity: 0.9; }
    .msg.me { align-self: flex-end; background: #dcf8c6; border-top-right-radius: 0; color: #000; }
    .msg.her { align-self: flex-start; background: #fff; border-top-left-radius: 0; color: #000; }
    
    .time { font-size: 10px; color: #999; pointer-events: none; line-height: 1;}

    /* Image Styles */
    .msg img { max-width: 100%; border-radius: 5px; margin-bottom: 2px; display: block; min-width: 50px;}

    /* Input Area */
    #input-area { display: flex; padding: 8px; background: #f0f0f0; gap: 8px; align-items: flex-end; min-height: 50px; box-sizing: border-box;}
    
    #txt { flex: 1; padding: 10px 15px; border-radius: 20px; border: none; outline: none; font-size: 15px; background: white; resize: none; font-family: inherit; height: 22px; max-height: 120px; overflow-y: auto; line-height: 20px;}
    
    .icon-btn { background: transparent; color: #555; width: 40px; height: 40px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 22px; transition: 0.2s; flex-shrink: 0;}
    .icon-btn:hover { background: #ddd; }
    .send-btn { background: #075e54; color: white; margin-bottom: 1px; width: 40px; height: 40px; font-size: 18px;} 
    .send-btn:hover { background: #064b42; }

    #imgInput { display: none; }
  </style>
</head>
<body>

  <div id="lock">
    <h2 style="color:#444; margin-bottom:20px;">üîí Restricted Access</h2>
    <p style="color:#666; margin-bottom:20px; font-size: 14px;">Enter your secret pass:</p>
    <input type="password" id="pass" class="pass" placeholder="Password..." autocomplete="off">
    <button class="btn" onclick="attemptLogin()">Enter</button>
    <p id="error" style="color:red; margin-top:10px; opacity:0; font-size:14px;">Wrong password!</p>
  </div>

  <div id="chat-wrap">
    <header>
      <div style="display:flex; align-items:center; gap:10px;">
        <div style="width:38px; height:38px; background:#fff; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#075e54; font-size:18px;">‚ù§Ô∏è</div>
        <div>
           <span id="header-title">Chat</span>
           <span id="status-indicator" class="status-text">Offline</span>
        </div>
      </div>
      <button onclick="location.reload()" style="background:transparent; border:none; color:rgba(255,255,255,0.9); cursor:pointer; font-size:13px; padding: 5px;">Logout</button>
    </header>
    
    <div id="messages"></div>
    
    <div id="input-area">
      <button class="icon-btn" onclick="document.getElementById('imgInput').click()" style="margin-bottom:2px">üì∑</button>
      <input type="file" id="imgInput" accept="image/*" onchange="handleImageUpload(this)">
      <textarea id="txt" placeholder="Type a message..." rows="1"></textarea>
      <button class="icon-btn send-btn" onclick="send()">‚û§</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, deleteDoc, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDznEmz6rxBJ_2QAgWIoEzWPBpM5QvocRQ",
      authDomain: "our-space-cbc39.firebaseapp.com",
      projectId: "our-space-cbc39",
      storageBucket: "our-space-cbc39.firebasestorage.app",
      messagingSenderId: "930162638208",
      appId: "1:930162638208:web:72cac87408d931efe01565"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    const PASS_ISHAN = "dumbass";
    const PASS_HER = "bawli";
    
    let currentUser = null; 
    let otherUser = null;   

    window.attemptLogin = () => {
      const p = document.getElementById('pass').value.toLowerCase().trim();
      if (p === PASS_ISHAN) { currentUser = "Ishan"; otherUser = "Her"; } 
      else if (p === PASS_HER) { currentUser = "Her"; otherUser = "Ishan"; } 
      else {
        const err = document.getElementById('error');
        err.style.opacity = '1'; setTimeout(() => err.style.opacity = '0', 2000); return;
      }

      document.getElementById('header-title').innerText = otherUser;
      document.getElementById('lock').style.display = 'none';
      document.getElementById('chat-wrap').style.display = 'flex';
      loadChat();
      startPresenceSystem();
    };

    window.send = async () => {
      const txt = document.getElementById('txt');
      const textVal = txt.value.trim(); 
      if(textVal) {
        try {
          await addDoc(collection(db, "chats"), {
            text: textVal, sender: currentUser, type: 'text', time: serverTimestamp()
          });
          txt.value = ""; txt.style.height = '22px'; txt.focus(); updateMyStatus(); 
        } catch(e) { console.error(e); }
      }
    };

    window.handleImageUpload = (input) => {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.src = e.target.result;
        img.onload = function() {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const maxWidth = 800;
          const scaleSize = maxWidth / img.width;
          canvas.width = maxWidth; canvas.height = img.height * scaleSize;
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          const dataUrl = canvas.toDataURL('image/jpeg', 0.7); 
          addDoc(collection(db, "chats"), {
            image: dataUrl, sender: currentUser, type: 'image', time: serverTimestamp()
          });
        }
      }
      reader.readAsDataURL(file);
      input.value = ''; 
    };

    window.deleteMsg = async (id) => {
      if(confirm("Delete this message?")) { try { await deleteDoc(doc(db, "chats", id)); } catch(e) {} }
    };

    function startPresenceSystem() {
      updateMyStatus();
      setInterval(updateMyStatus, 60000);
      onSnapshot(doc(db, "status", otherUser), (docSnap) => {
        if (docSnap.exists()) {
          const diff = (new Date() - docSnap.data().lastSeen.toDate()) / 1000; 
          const el = document.getElementById('status-indicator');
          if (diff < 120) { el.innerText = "Online üü¢"; el.style.color = "#cfc"; } 
          else { el.innerText = "Offline"; el.style.color = "rgba(255,255,255,0.7)"; }
        }
      });
    }

    async function updateMyStatus() { try { await setDoc(doc(db, "status", currentUser), { lastSeen: serverTimestamp() }); } catch(e) {} }

    function loadChat() {
      const q = query(collection(db, "chats"), orderBy("time", "asc"));
      onSnapshot(q, (snap) => {
        const div = document.getElementById('messages');
        div.innerHTML = ""; 
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const id = docSnap.id;
          if(!d.time) return; 

          if ((new Date() - d.time.toDate()) / 1000 / 60 / 60 > 24) { deleteDoc(doc(db, "chats", id)); return; }
          
          const isMe = d.sender === currentUser;
          const tStr = d.time.toDate().getHours() + ":" + String(d.time.toDate().getMinutes()).padStart(2,'0');
          
          let contentHtml = "";
          if (d.type === 'image') {
             contentHtml = `<img src="${d.image}" onload="scrollToBottom()">`;
          } else {
             // NOTE: I removed all whitespace in the HTML string below to fix your bug
             contentHtml = `<span class="msg-content">${d.text ? d.text.trim() : ""}</span>`;
          }

          // IMPORTANT: The HTML string is now condensed to prevent ghost whitespace
          div.innerHTML += `<div class="msg ${isMe ? 'me' : 'her'}" ondblclick="deleteMsg('${id}')">${contentHtml}<span class="time">${tStr}</span></div>`;
        });
        scrollToBottom(); setTimeout(scrollToBottom, 200);
      });
    }

    window.scrollToBottom = function() {
      const div = document.getElementById('messages');
      div.scrollTop = div.scrollHeight;
    }

    document.getElementById('pass').addEventListener('keydown', (e) => { if(e.key === 'Enter') attemptLogin(); });
    const txtInput = document.getElementById('txt');
    txtInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
    });
    txtInput.addEventListener('input', function() {
      this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';
      if(this.value === '') this.style.height = '22px';
    });
  </script>
</body>
</html>
