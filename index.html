<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Secure Chats</title>
  <style>
    /* --- CORE THEME --- */
    body { margin: 0; background: #ece5dd; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; height: 100vh; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
    
    /* --- LOCK SCREEN --- */
    #lock-screen { position: fixed; inset: 0; background: #fff; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
    .lock-logo { width: 80px; height: 80px; background: #128C7E; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 40px; color: white; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    input.pass { padding: 15px; font-size: 18px; border-radius: 30px; border: 1px solid #ccc; text-align: center; margin-bottom: 15px; width: 80%; max-width: 300px; outline: none; }
    button.btn { padding: 12px 30px; background: #075e54; color: white; border: none; border-radius: 30px; font-size: 16px; cursor: pointer; font-weight: bold; }
    
    /* --- ADMIN PANEL --- */
    #contact-screen { display: none; flex-direction: column; height: 100%; background: #fff; position: relative; }
    .app-header { background: #075e54; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.2); z-index: 10; }
    .header-content h1 { margin: 0; font-size: 20px; font-weight: 500; display: flex; align-items: center; gap: 8px; }
    .edit-self-btn { background: none; border: none; color: rgba(255,255,255,0.7); font-size: 16px; cursor: pointer; }
    .contact-list { flex: 1; overflow-y: auto; padding-bottom: 80px; }
    
    .contact { border-bottom: 1px solid #f0f0f0; padding: 15px; }
    .contact-main { display: flex; align-items: center; cursor: pointer; justify-content: space-between; }
    .contact-main:active { background: #f9f9f9; }
    .contact-left { display: flex; align-items: center; gap: 15px; flex: 1; min-width: 0; }
    .avatar { width: 50px; height: 50px; border-radius: 50%; background: #ddd; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #fff; font-weight: bold; flex-shrink: 0; }
    .info { overflow: hidden; flex: 1; }
    .info h3 { margin: 0; font-size: 17px; color: #111; font-weight: 500; }
    .info p { margin: 4px 0 0; font-size: 14px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .contact-actions { display: flex; align-items: center; gap: 5px; }
    .action-icon { background: none; border: none; font-size: 18px; cursor: pointer; opacity: 0.5; padding: 8px; }
    .delete-btn { color: #ff4444; }
    .edit-btn { color: #075e54; }
    
    /* Sub-Contacts (Spy Badges) */
    .sub-contacts { padding-left: 65px; display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .sub-badge { background: #e8f5e9; color: #075e54; border: 1px solid #075e54; border-radius: 12px; padding: 4px 10px; font-size: 11px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
    .sub-badge:hover { background: #c8e6c9; }
    
    .fab { position: absolute; bottom: 20px; right: 20px; width: 60px; height: 60px; background: #25D366; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; border: none; transition: transform 0.2s; }
    .fab:active { transform: scale(0.9); }

    /* --- CHAT SCREEN --- */
    #chat-screen { display: none; flex-direction: column; height: 100%; background: #e5ddd5; position: relative; background-size: cover; background-position: center; transition: background-image 0.3s ease; }
    #chat-screen.has-wallpaper::before { content: ""; position: absolute; inset: 0; background: rgba(0,0,0,0.6); pointer-events: none; }

    .chat-header { background: #075e54; color: white; padding: 10px 15px; display: flex; align-items: center; gap: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); z-index: 10; }
    .back-btn { background: transparent; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0 5px; margin-right: 5px; }
    .header-profile { display: flex; align-items: center; gap: 10px; flex: 1; }
    .header-avatar { width: 40px; height: 40px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #075e54; font-size: 20px; }
    .header-info h4 { margin: 0; font-size: 16px; font-weight: 500; }
    .header-status { font-size: 12px; opacity: 0.8; display: block; }
    #spy-indicator { display: none; background: #000; color: #0f0; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-family: monospace; letter-spacing: 1px; border: 1px solid #0f0; }

    #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 4px; scroll-behavior: smooth; z-index: 1; }
    .msg { padding: 6px 10px; border-radius: 7.5px; max-width: 75%; width: fit-content; font-size: 15px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); line-height: 1.3; cursor: pointer; user-select: none; display: flex; flex-direction: column; }
    .msg.me { align-self: flex-end; background: #dcf8c6; border-top-right-radius: 0; align-items: flex-end;}
    .msg.her { align-self: flex-start; background: #fff; border-top-left-radius: 0; align-items: flex-start;}
    .msg-sender-name { font-size: 10px; color: #e53935; font-weight: bold; margin-bottom: 2px; } 
    .msg-content { white-space: pre-wrap; word-wrap: break-word; max-width: 100%; }
    .time { font-size: 10px; color: #999; margin-top: 2px; margin-left: 5px; min-width: 40px; text-align: right;}
    .msg img { max-width: 100%; border-radius: 5px; margin-bottom: 2px; display: block; min-width: 50px;}

    #reply-preview { display: none; background: #f0f0f0; border-left: 5px solid #075e54; padding: 8px 12px; justify-content: space-between; align-items: center; border-top: 1px solid #ddd; }
    #reply-info { flex: 1; overflow: hidden; }
    #reply-to-name { font-weight: bold; color: #075e54; font-size: 12px; }
    #reply-to-text { font-size: 12px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    #cancel-reply { border: none; background: transparent; font-size: 18px; cursor: pointer;}
    .quote-box { background: rgba(0,0,0,0.06); border-left: 4px solid #075e54; border-radius: 4px; padding: 4px 8px; margin-bottom: 4px; font-size: 12px; color: #555; display: flex; flex-direction: column; }

    #input-area { display: flex; padding: 8px; background: #f0f0f0; gap: 8px; align-items: flex-end; min-height: 50px; box-sizing: border-box; z-index: 1; padding-bottom: max(8px, env(safe-area-inset-bottom)); }
    #input-area.hidden { display: none !important; } 
    #txt { flex: 1; padding: 10px 15px; border-radius: 20px; border: none; outline: none; font-size: 15px; background: white; resize: none; font-family: inherit; height: 22px; max-height: 120px; overflow-y: auto; line-height: 20px;}
    .icon-btn { background: transparent; color: #555; width: 40px; height: 40px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 22px; transition: 0.2s; flex-shrink: 0;}
    .send-btn { background: #075e54; color: white; margin-bottom: 1px; width: 40px; height: 40px; font-size: 18px;} 
    #imgInput, #wallpaperInput { display: none; }
    .action-btn { background: transparent; border: none; color: white; font-size: 20px; cursor: pointer; padding: 5px; }

    #wp-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; }
    .wp-card { background: white; width: 80%; max-width: 300px; border-radius: 10px; padding: 20px; text-align: center; }
    .wp-btn { display: block; width: 100%; padding: 10px; margin: 10px 0; background: #eee; border: none; border-radius: 5px; cursor: pointer; }
    .wp-btn.primary { background: #075e54; color: white; font-weight: bold; }
  </style>
</head>
<body>

  <div id="lock-screen">
    <div class="lock-logo">üîí</div>
    <h2 style="color:#444; margin-bottom:20px;">Secure Access</h2>
    <input type="password" id="pass" class="pass" placeholder="Password" autocomplete="off">
    <button class="btn" onclick="attemptLogin()">Unlock</button>
    <p id="error" style="color:red; margin-top:10px; opacity:0; font-size:14px;">Access Denied</p>
  </div>

  <!-- Admin Panel -->
  <div id="contact-screen">
    <div class="app-header">
      <div class="header-content">
        <h1>Chats <button class="edit-self-btn" onclick="renameSelf()" title="Rename Self">‚úé</button></h1>
        <span style="font-size:14px; opacity:0.8;" id="header-role">Guest</span>
      </div>
    </div>
    <div class="contact-list" id="contact-list-container"></div>
    <button class="fab" onclick="handleAddButton()">+</button>
  </div>

  <!-- Chat Screen -->
  <div id="chat-screen">
    <div class="chat-header">
      <button class="back-btn" onclick="goBack()">‚Üê</button>
      <div class="header-profile">
        <div class="header-avatar" id="chat-avatar">üë§</div>
        <div class="header-info">
          <h4 id="chat-name">Name</h4>
          <span class="header-status" id="chat-status">offline</span>
        </div>
      </div>
      <div id="spy-indicator">üëÅÔ∏è SPYING</div>
      <button class="action-btn" onclick="openWallpaperModal()">üñºÔ∏è</button>
    </div>
    <div id="messages"></div>
    
    <div id="reply-preview">
      <div id="reply-info">
        <div id="reply-to-name">Replying...</div>
        <div id="reply-to-text"></div>
      </div>
      <button id="cancel-reply" onclick="cancelReply()">‚úñ</button>
    </div>

    <div id="input-area">
      <button class="icon-btn" onclick="document.getElementById('imgInput').click()">üì∑</button>
      <input type="file" id="imgInput" accept="image/*" onchange="handleImageUpload(this)">
      <textarea id="txt" placeholder="Message" rows="1"></textarea>
      <button class="icon-btn send-btn" onclick="send()">‚û§</button>
    </div>
  </div>

  <!-- Wallpaper Modal -->
  <div id="wp-modal">
    <div class="wp-card">
      <h3>Wallpaper</h3>
      <button class="wp-btn primary" onclick="document.getElementById('wallpaperInput').click()">Upload</button>
      <button class="wp-btn" onclick="useLastPhoto()">Use Last Photo</button>
      <button class="wp-btn" onclick="resetWallpaper()">Reset</button>
      <button class="wp-btn" onclick="closeWallpaperModal()">Cancel</button>
      <input type="file" id="wallpaperInput" accept="image/*" onchange="handleWallpaperUpload(this)">
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, getDoc, getDocs, orderBy, onSnapshot, serverTimestamp, deleteDoc, doc, setDoc, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDznEmz6rxBJ_2QAgWIoEzWPBpM5QvocRQ",
      authDomain: "our-space-cbc39.firebaseapp.com",
      projectId: "our-space-cbc39",
      storageBucket: "our-space-cbc39.firebasestorage.app",
      messagingSenderId: "930162638208",
      appId: "1:930162638208:web:72cac87408d931efe01565"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const ADMIN_EMAIL = "admin@secret.com"; 
    
    let currentCollection = null;
    let currentUserDisplay = null; 
    let currentUserId = null; 
    let isAdmin = false;
    let isSpying = false;
    let guestData = null; 
    
    let unsubscribeChat, unsubscribeUsers;
    let lastImageSent, replyTarget;

    // --- 1. LOGIN ---
    window.attemptLogin = async () => {
      const p = document.getElementById('pass').value.trim();
      try {
        await signInWithEmailAndPassword(auth, ADMIN_EMAIL, p)
          .then(() => { 
            isAdmin = true; 
            currentUserDisplay = "Ishan";
            unlock(); 
            initAdminDashboard(); 
          })
          .catch(async () => {
            await signInAnonymously(auth);
            const snap = await getDoc(doc(db, "users", p.toLowerCase()));
            if (snap.exists()) { 
              isAdmin = false; 
              guestData = snap.data(); 
              currentUserDisplay = guestData.name;
              currentUserId = p.toLowerCase();
              unlock(); 
              initGuestDashboard(); 
            } 
            else throw "Invalid";
          });
      } catch (e) {
        document.getElementById('error').style.opacity = '1';
        setTimeout(() => document.getElementById('error').style.opacity = '0', 2000);
      }
    };

    function unlock() { document.getElementById('lock-screen').style.display = 'none'; }

    // --- 2. ADMIN DASHBOARD ---
    function initAdminDashboard() {
      document.getElementById('contact-screen').style.display = 'flex';
      document.getElementById('header-role').innerText = "God Mode";
      document.querySelector('.edit-self-btn').style.display = 'none'; 
      
      const q = query(collection(db, "users"), orderBy("created", "desc"));
      unsubscribeUsers = onSnapshot(q, (snap) => {
        const list = document.getElementById('contact-list-container');
        list.innerHTML = "";
        snap.forEach(async (docSnap) => {
          const u = docSnap.data();
          const uid = docSnap.id;
          
          const div = document.createElement('div');
          div.className = 'contact';
          div.innerHTML = `
            <div class="contact-main" onclick="openChat('${u.collection}', '${u.name}', '${u.color}', false)">
              <div class="contact-left">
                <div class="avatar" style="background:${u.color}">${u.name[0]}</div>
                <div class="info"><h3>${u.name}</h3><p>Pass: ${uid}</p></div>
              </div>
              <div class="contact-actions">
                <button class="action-icon delete-btn" onclick="deleteUser(event, '${uid}', '${u.name}')">üóëÔ∏è</button>
              </div>
            </div>
            <div class="sub-contacts" id="subs-${uid}"></div>`;
          list.appendChild(div);

          const subContainer = document.getElementById(`subs-${uid}`);
          const subQ = query(collection(db, `users/${uid}/contacts`));
          const subSnap = await getDocs(subQ);
          subSnap.forEach(sub => {
            const g = sub.data();
            const badge = document.createElement('div');
            badge.className = 'sub-badge';
            badge.innerHTML = `üìÅ ${g.name}`;
            badge.onclick = (e) => { e.stopPropagation(); openChat(g.roomId, `${u.name}'s: ${g.name}`, g.color, true); };
            subContainer.appendChild(badge);
          });
        });
      });
    }

    // --- 3. GUEST DASHBOARD ---
    function initGuestDashboard() {
      document.getElementById('contact-screen').style.display = 'flex';
      document.getElementById('header-role').innerText = currentUserDisplay;
      
      const list = document.getElementById('contact-list-container');
      
      // Default Admin Chat
      renderGuestContact(list, "Ishan ‚ù§Ô∏è", "#075e54", "Private Chat", guestData.collection, null);

      // Real-time Contacts
      const subQ = query(collection(db, `users/${currentUserId}/contacts`));
      onSnapshot(subQ, (snap) => {
        list.innerHTML = "";
        renderGuestContact(list, "Ishan ‚ù§Ô∏è", "#075e54", "Private Chat", guestData.collection, null);
        snap.forEach(doc => {
          const d = doc.data();
          renderGuestContact(list, d.name, d.color, "Chat", d.roomId, doc.id);
        });
      });
    }

    function renderGuestContact(container, name, color, subtext, roomId, contactDocId) {
      const div = document.createElement('div');
      div.className = 'contact';
      
      let actions = "";
      if (contactDocId) {
        actions = `
          <button class="action-icon edit-btn" onclick="renameContact(event, '${contactDocId}', '${name}')">‚úé</button>
          <button class="action-icon delete-btn" onclick="deleteContact(event, '${contactDocId}')">üóëÔ∏è</button>`;
      }

      div.innerHTML = `
        <div class="contact-main" onclick="openChat('${roomId}', '${name}', '${color}', false)">
          <div class="contact-left">
            <div class="avatar" style="background:${color}">${name[0]}</div>
            <div class="info"><h3>${name}</h3><p>${subtext}</p></div>
          </div>
          <div class="contact-actions">${actions}</div>
        </div>`;
      container.appendChild(div);
    }

    // --- CHAT LOGIC ---
    window.openChat = (roomId, name, color, asSpy) => {
      currentCollection = roomId;
      isSpying = asSpy;
      document.getElementById('contact-screen').style.display = 'none';
      document.getElementById('chat-screen').style.display = 'flex';
      document.getElementById('chat-name').innerText = name;
      const av = document.getElementById('chat-avatar');
      av.innerText = name[0]; av.style.background = color || "#fff"; av.style.color = color ? "#fff" : "#075e54";
      
      if (isSpying) {
        document.getElementById('input-area').classList.add('hidden');
        // Removed visual indicator for stealth
        document.getElementById('spy-indicator').style.display = 'none'; 
      } else {
        document.getElementById('input-area').classList.remove('hidden');
        document.getElementById('spy-indicator').style.display = 'none';
      }
      loadChat(); loadWallpaper();
    };

    window.goBack = () => {
      if (unsubscribeChat) unsubscribeChat();
      document.getElementById('chat-screen').style.display = 'none';
      document.getElementById('contact-screen').style.display = 'flex';
      currentCollection = null; cancelReply();
    };

    function loadChat() {
      const q = query(collection(db, currentCollection), orderBy("time", "asc"));
      unsubscribeChat = onSnapshot(q, (snap) => {
        const div = document.getElementById('messages');
        div.innerHTML = ""; 
        snap.forEach(docSnap => {
          const d = docSnap.data();
          if(docSnap.id.startsWith('_') || !d.time) return;
          if ((new Date() - d.time.toDate())/36e5 > 24) { deleteDoc(doc(db, currentCollection, docSnap.id)); return; }
          if (d.type === 'image') lastImageSent = d.image;

          const isMe = d.sender === currentUserDisplay;
          const tStr = d.time.toDate().getHours() + ":" + String(d.time.toDate().getMinutes()).padStart(2,'0');
          const msgDiv = document.createElement('div');
          msgDiv.className = `msg ${isMe ? 'me' : 'her'}`;
          
          msgDiv.oncontextmenu = (e) => { e.preventDefault(); if(isAdmin || isMe) { if(confirm("Delete?")) deleteMsg(docSnap.id); } };
          msgDiv.ondblclick = (e) => { e.preventDefault(); startReply(d.sender, d.text || "Photo"); };

          if (!isMe && !isSpying) { 
             const nameSpan = document.createElement('div');
             nameSpan.className = 'msg-sender-name';
             nameSpan.textContent = d.sender;
             msgDiv.appendChild(nameSpan);
          }
          if (d.reply) {
            const quoteDiv = document.createElement('div');
            quoteDiv.className = 'quote-box';
            quoteDiv.innerHTML = `<span style="font-weight:bold">${d.reply.sender}</span><br><span>${d.reply.text}</span>`;
            msgDiv.appendChild(quoteDiv);
          }
          if (d.type === 'image') {
            msgDiv.innerHTML += `<img src="${d.image}" onload="scrollToBottom()">`;
          } else {
            const contentDiv = document.createElement('div');
            contentDiv.className = 'msg-content';
            contentDiv.textContent = d.text;
            msgDiv.appendChild(contentDiv);
          }
          const timeSpan = document.createElement('span');
          timeSpan.className = 'time';
          timeSpan.textContent = tStr;
          msgDiv.appendChild(timeSpan);
          div.appendChild(msgDiv);
        });
        scrollToBottom(); setTimeout(scrollToBottom, 200);
      });
    }

    // RENAME & ACTIONS
    window.renameSelf = async () => {
      const newName = prompt("Enter new Display Name:", currentUserDisplay);
      if (!newName || newName === currentUserDisplay) return;
      try {
        await updateDoc(doc(db, "users", currentUserId), { name: newName });
        await deleteDoc(doc(db, "directory", currentUserDisplay.toLowerCase()));
        await setDoc(doc(db, "directory", newName.toLowerCase()), { uid: currentUserId, name: newName });
        currentUserDisplay = newName;
        document.getElementById('header-role').innerText = newName;
        alert("Name updated!");
      } catch(e) { alert("Update failed."); }
    };
    window.renameContact = async (e, contactId, oldName) => {
      e.stopPropagation();
      const newName = prompt("Rename chat:", oldName);
      if (!newName) return;
      await updateDoc(doc(db, `users/${currentUserId}/contacts`, contactId), { name: newName });
    };

    window.handleAddButton = async () => {
      if(isAdmin) {
        const name = prompt("New User Name:"); if (!name) return;
        const password = prompt("Password (lowercase):").toLowerCase().trim(); if (!password) return;
        const colors = ["#4ecdc4", "#ffe66d", "#1a535c", "#ff9f1c", "#ff6b6b"];
        await setDoc(doc(db, "users", password), {
          name: name, collection: "chats_" + Date.now(),
          color: colors[Math.floor(Math.random()*colors.length)], created: serverTimestamp()
        });
        await setDoc(doc(db, "directory", name.toLowerCase()), { uid: password, name: name });
      } else {
        const targetName = prompt("Enter Name to add:"); if (!targetName) return;
        try {
          const dirSnap = await getDoc(doc(db, "directory", targetName.toLowerCase()));
          if (!dirSnap.exists()) { alert("User not found."); return; }
          const targetData = dirSnap.data();
          const sharedRoomId = "private_" + [currentUserId, targetData.uid].sort().join("_");
          const color = ["#4ecdc4", "#ffe66d", "#1a535c", "#ff9f1c", "#ff6b6b"][Math.floor(Math.random()*5)];
          await addDoc(collection(db, `users/${currentUserId}/contacts`), { name: targetData.name, roomId: sharedRoomId, color: color });
          await addDoc(collection(db, `users/${targetData.uid}/contacts`), { name: currentUserDisplay, roomId: sharedRoomId, color: color });
          alert(`Added ${targetData.name}!`);
        } catch (e) { alert("Error adding contact."); }
      }
    };

    window.deleteUser = async (e, uid, name) => { e.stopPropagation(); if (confirm(`Delete User ${name}?`)) await deleteDoc(doc(db, "users", uid)); };
    window.deleteContact = async (e, contactId) => { e.stopPropagation(); if (confirm("Remove this chat?")) await deleteDoc(doc(db, `users/${currentUserId}/contacts`, contactId)); };

    // Utils
    window.startReply = (sender, text) => { replyTarget = { sender, text }; document.getElementById('reply-preview').style.display = 'flex'; document.getElementById('reply-to-name').textContent = "Replying to " + sender; document.getElementById('reply-to-text').textContent = text; document.getElementById('txt').focus(); };
    window.cancelReply = () => { replyTarget = null; document.getElementById('reply-preview').style.display = 'none'; };
    function loadWallpaper() { 
        getDoc(doc(db, currentCollection, "_settings")).then(docSnap => {
            const screen = document.getElementById('chat-screen'); 
            if (docSnap.exists() && docSnap.data().wallpaper) { 
                screen.style.backgroundImage = `url('${docSnap.data().wallpaper}')`; screen.classList.add('has-wallpaper'); 
            } else { screen.style.backgroundImage = ''; screen.classList.remove('has-wallpaper'); } 
        });
    }
    window.send = async () => { const txt = document.getElementById('txt'); const val = txt.value.trim(); if(val && currentCollection) { const payload = { text: val, sender: currentUserDisplay, type: 'text', time: serverTimestamp() }; if (replyTarget) { payload.reply = replyTarget; cancelReply(); } await addDoc(collection(db, currentCollection), payload); txt.value = ""; txt.style.height = '22px'; txt.focus(); } };
    window.handleImageUpload = (input) => { const file = input.files[0]; if (!file) return; processImage(file, (base64) => { addDoc(collection(db, currentCollection), { image: base64, sender: currentUserDisplay, type: 'image', time: serverTimestamp() }); }); input.value = ''; };
    window.handleWallpaperUpload = (input) => { const file = input.files[0]; if(!file) return; processImage(file, (base64) => setWallpaper(base64)); input.value = ''; document.getElementById('wp-modal').style.display = 'none'; };
    function processImage(file, callback) { const reader = new FileReader(); reader.onload = (e) => { const img = new Image(); img.src = e.target.result; img.onload = () => { const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d'); const sc = 800 / img.width; cvs.width = 800; cvs.height = img.height * sc; ctx.drawImage(img, 0, 0, cvs.width, cvs.height); callback(cvs.toDataURL('image/jpeg', 0.7)); } }; reader.readAsDataURL(file); }
    async function setWallpaper(url) { await setDoc(doc(db, currentCollection, "_settings"), { wallpaper: url }, { merge: true }); loadWallpaper(); }
    window.useLastPhoto = () => { if(lastImageSent) { setWallpaper(lastImageSent); closeWallpaperModal(); } else alert("No photos!"); };
    window.resetWallpaper = async () => { await setDoc(doc(db, currentCollection, "_settings"), { wallpaper: null }, { merge: true }); closeWallpaperModal(); loadWallpaper(); };
    window.openWallpaperModal = () => document.getElementById('wp-modal').style.display = 'flex';
    window.closeWallpaperModal = () => document.getElementById('wp-modal').style.display = 'none';
    window.deleteMsg = async (id) => { if(currentCollection) await deleteDoc(doc(db, currentCollection, id)); };
    function scrollToBottom() { const div = document.getElementById('messages'); div.scrollTop = div.scrollHeight; }
    
    document.getElementById('pass').addEventListener('keydown', (e) => { if(e.key === 'Enter') attemptLogin(); });
    const txtInput = document.getElementById('txt');
    txtInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); } });
    txtInput.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; if(this.value === '') this.style.height = '22px'; });
  </script>
</body>
</html>
