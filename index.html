<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Secure Chats</title>
  <style>
    /* --- CORE THEME --- */
    /* height: 100dvh forces it to fit within mobile browser bars */
    body { margin: 0; background: #ece5dd; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; height: 100vh; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
    
    /* --- LOCK SCREEN --- */
    #lock-screen { position: fixed; inset: 0; background: #fff; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
    .lock-logo { width: 80px; height: 80px; background: #128C7E; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 40px; color: white; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    input.pass { padding: 15px; font-size: 18px; border-radius: 30px; border: 1px solid #ccc; text-align: center; margin-bottom: 15px; width: 80%; max-width: 300px; outline: none; }
    button.btn { padding: 12px 30px; background: #075e54; color: white; border: none; border-radius: 30px; font-size: 16px; cursor: pointer; font-weight: bold; }
    
    /* --- ADMIN PANEL --- */
    #contact-screen { display: none; flex-direction: column; height: 100%; background: #fff; position: relative; }
    .app-header { background: #075e54; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.2); z-index: 10; }
    .app-header h1 { margin: 0; font-size: 20px; font-weight: 500; }
    .contact-list { flex: 1; overflow-y: auto; padding-bottom: 80px; }
    .contact { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; justify-content: space-between; }
    .contact-left { display: flex; align-items: center; gap: 15px; flex: 1; }
    .avatar { width: 50px; height: 50px; border-radius: 50%; background: #ddd; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #fff; font-weight: bold; flex-shrink: 0; }
    .info h3 { margin: 0; font-size: 17px; color: #111; font-weight: 500; }
    .info p { margin: 4px 0 0; font-size: 14px; color: #666; }
    .delete-btn { background: none; border: none; color: #ff4444; font-size: 20px; padding: 10px; cursor: pointer; }
    .fab { position: absolute; bottom: 20px; right: 20px; width: 60px; height: 60px; background: #25D366; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; border: none; }

    /* --- CHAT SCREEN --- */
    #chat-screen { display: none; flex-direction: column; height: 100%; background: #e5ddd5; position: relative; background-size: cover; background-position: center; transition: background-image 0.3s ease; }
    #chat-screen::before { content: ""; position: absolute; inset: 0; background: rgba(255,255,255,0.0); pointer-events: none; transition: background 0.3s; }
    #chat-screen.has-wallpaper::before { background: rgba(0,0,0,0.6); }

    .chat-header { background: #075e54; color: white; padding: 10px 15px; display: flex; align-items: center; gap: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); z-index: 10; }
    .back-btn { background: transparent; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0 5px; display: none; }
    .header-profile { display: flex; align-items: center; gap: 10px; flex: 1; }
    .header-avatar { width: 40px; height: 40px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #075e54; font-size: 20px; }
    .header-info h4 { margin: 0; font-size: 16px; font-weight: 500; }
    .header-status { font-size: 12px; opacity: 0.8; display: block; }
    .action-btn { background: transparent; border: none; color: white; font-size: 20px; cursor: pointer; padding: 5px; }

    #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 4px; scroll-behavior: smooth; z-index: 1; }
    .msg { padding: 6px 10px; border-radius: 7.5px; max-width: 75%; width: fit-content; font-size: 15px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); line-height: 1.3; cursor: pointer; user-select: none; display: flex; flex-direction: column; }
    .msg.me { align-self: flex-end; background: #dcf8c6; border-top-right-radius: 0; align-items: flex-end;}
    .msg.her { align-self: flex-start; background: #fff; border-top-left-radius: 0; align-items: flex-start;}
    .msg-content { white-space: pre-wrap; word-wrap: break-word; max-width: 100%; }
    .time { font-size: 10px; color: #999; margin-top: 2px; margin-left: 5px; min-width: 40px; text-align: right;}
    .msg img { max-width: 100%; border-radius: 5px; margin-bottom: 2px; display: block; min-width: 50px;}

    /* Input Area with Safe Area padding */
    #input-area { display: flex; padding: 8px; background: #f0f0f0; gap: 8px; align-items: flex-end; min-height: 50px; box-sizing: border-box; z-index: 1; padding-bottom: max(8px, env(safe-area-inset-bottom)); }
    #txt { flex: 1; padding: 10px 15px; border-radius: 20px; border: none; outline: none; font-size: 15px; background: white; resize: none; font-family: inherit; height: 22px; max-height: 120px; overflow-y: auto; line-height: 20px;}
    .icon-btn { background: transparent; color: #555; width: 40px; height: 40px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 22px; transition: 0.2s; flex-shrink: 0;}
    .send-btn { background: #075e54; color: white; margin-bottom: 1px; width: 40px; height: 40px; font-size: 18px;} 
    #imgInput, #wallpaperInput { display: none; }

    /* Wallpaper Modal */
    #wp-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; }
    .wp-card { background: white; width: 80%; max-width: 300px; border-radius: 10px; padding: 20px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .wp-btn { display: block; width: 100%; padding: 10px; margin: 10px 0; background: #eee; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
    .wp-btn.primary { background: #075e54; color: white; font-weight: bold; }
    .wp-btn.close { background: transparent; color: #555; margin-top: 0; }
  </style>
</head>
<body>

  <div id="lock-screen">
    <div class="lock-logo">üîí</div>
    <h2 style="color:#444; margin-bottom:20px;">Secure Access</h2>
    <input type="password" id="pass" class="pass" placeholder="Password" autocomplete="off">
    <button class="btn" onclick="attemptLogin()">Unlock</button>
    <p id="error" style="color:red; margin-top:10px; opacity:0; font-size:14px;">Access Denied</p>
  </div>

  <!-- Admin Panel -->
  <div id="contact-screen">
    <div class="app-header">
      <h1>Secret Chats</h1>
      <span style="font-size:14px; opacity:0.8;">Admin</span>
    </div>
    <div class="contact-list" id="contact-list-container"></div>
    <button class="fab" onclick="addNewUser()">+</button>
  </div>

  <!-- Chat Screen -->
  <div id="chat-screen">
    <div class="chat-header">
      <button class="back-btn" id="back-btn" onclick="goBack()">‚Üê</button>
      <div class="header-profile">
        <div class="header-avatar" id="chat-avatar">üë§</div>
        <div class="header-info">
          <h4 id="chat-name">Name</h4>
          <span class="header-status" id="chat-status">offline</span>
        </div>
      </div>
      <button class="action-btn" onclick="openWallpaperModal()">üñºÔ∏è</button>
    </div>
    <div id="messages"></div>
    <div id="input-area">
      <button class="icon-btn" onclick="document.getElementById('imgInput').click()">üì∑</button>
      <input type="file" id="imgInput" accept="image/*" onchange="handleImageUpload(this)">
      <textarea id="txt" placeholder="Message" rows="1"></textarea>
      <button class="icon-btn send-btn" onclick="send()">‚û§</button>
    </div>
  </div>

  <!-- Wallpaper Modal -->
  <div id="wp-modal">
    <div class="wp-card">
      <h3 style="margin-top:0;">Chat Wallpaper</h3>
      <button class="wp-btn primary" onclick="document.getElementById('wallpaperInput').click()">Upload New</button>
      <button class="wp-btn" onclick="useLastPhoto()">Use Last Chat Photo</button>
      <button class="wp-btn" onclick="resetWallpaper()">Reset to Default</button>
      <button class="wp-btn close" onclick="closeWallpaperModal()">Cancel</button>
      <input type="file" id="wallpaperInput" accept="image/*" onchange="handleWallpaperUpload(this)">
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, getDoc, orderBy, onSnapshot, serverTimestamp, deleteDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDznEmz6rxBJ_2QAgWIoEzWPBpM5QvocRQ",
      authDomain: "our-space-cbc39.firebaseapp.com",
      projectId: "our-space-cbc39",
      storageBucket: "our-space-cbc39.firebasestorage.app",
      messagingSenderId: "930162638208",
      appId: "1:930162638208:web:72cac87408d931efe01565"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ADMIN_EMAIL = "admin@secret.com"; 
    
    let currentCollection = null;
    let currentUserDisplay = null;
    let isAdmin = false;
    let unsubscribeChat = null;
    let unsubscribeUsers = null;
    let unsubscribeSettings = null;
    let unsubscribePresence = null;
    let presenceInterval = null;
    let lastImageSent = null;

    // --- 1. LOGIN ---
    window.attemptLogin = async () => {
      const p = document.getElementById('pass').value.trim();
      const lock = document.getElementById('lock-screen');
      const errorMsg = document.getElementById('error');

      try {
        await signInWithEmailAndPassword(auth, ADMIN_EMAIL, p)
          .then(() => {
            isAdmin = true;
            unlock(lock);
            startAdminMode();
          })
          .catch(async (error) => {
            await signInAnonymously(auth);
            const docRef = doc(db, "users", p.toLowerCase()); 
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
              isAdmin = false;
              unlock(lock);
              startGuestMode(docSnap.data());
            } else {
              throw "Invalid";
            }
          });
      } catch (e) {
        console.error(e);
        errorMsg.innerText = "Access Denied";
        errorMsg.style.opacity = '1';
        setTimeout(() => errorMsg.style.opacity = '0', 2000);
      }
    };

    function unlock(el) {
      el.style.opacity = '0'; setTimeout(() => el.style.display = 'none', 500);
    }

    // --- 2. ADMIN MODE ---
    function startAdminMode() {
      document.getElementById('contact-screen').style.display = 'flex';
      const q = query(collection(db, "users"), orderBy("created", "desc"));
      unsubscribeUsers = onSnapshot(q, (snap) => {
        const list = document.getElementById('contact-list-container');
        list.innerHTML = "";
        snap.forEach(docSnap => {
          const u = docSnap.data();
          const div = document.createElement('div');
          div.className = 'contact';
          div.innerHTML = `
            <div class="contact-left">
              <div class="avatar" style="background:${u.color}">${u.name[0]}</div>
              <div class="info"><h3></h3><p></p></div>
            </div>
            <button class="delete-btn">üóëÔ∏è</button>`;
          div.querySelector('h3').textContent = u.name;
          div.querySelector('p').textContent = `Pass: ${docSnap.id}`;
          div.querySelector('.contact-left').onclick = () => openChatAsAdmin(u.collection, u.name, u.color);
          div.querySelector('.delete-btn').onclick = () => deleteUser(docSnap.id, u.name);
          list.appendChild(div);
        });
      });
    }

    window.addNewUser = async () => {
      const name = prompt("Name:");
      if (!name) return;
      const password = prompt("Password (lowercase):").toLowerCase().trim();
      if (!password) return;
      const colors = ["#4ecdc4", "#ffe66d", "#1a535c", "#ff9f1c", "#ff6b6b"];
      await setDoc(doc(db, "users", password), {
        name: name, collection: "chats_" + Date.now(),
        color: colors[Math.floor(Math.random()*colors.length)], created: serverTimestamp()
      });
    };
    window.deleteUser = async (uid, name) => { if (confirm(`Delete ${name}?`)) await deleteDoc(doc(db, "users", uid)); };
    window.openChatAsAdmin = (coll, name, color) => {
      setupChatUI(coll, "Ishan", name, color);
      document.getElementById('back-btn').style.display = 'block';
      document.getElementById('contact-screen').style.display = 'none';
    };

    // --- 3. GUEST MODE ---
    function startGuestMode(userData) {
      setupChatUI(userData.collection, userData.name, "Ishan", "#075e54");
      document.getElementById('back-btn').style.display = 'none';
    }

    function setupChatUI(coll, asUser, chatName, chatColor) {
      currentCollection = coll;
      currentUserDisplay = asUser;
      
      document.getElementById('chat-screen').style.display = 'flex';
      document.getElementById('chat-name').innerText = chatName;
      const av = document.getElementById('chat-avatar');
      av.innerText = chatName[0]; 
      av.style.background = chatColor || "#fff"; 
      av.style.color = chatColor ? "#fff" : "#075e54";
      
      loadChat();
      loadWallpaper();
      initPresence(); // START THE PRESENCE ENGINE
    }

    window.goBack = () => {
      if (unsubscribeChat) unsubscribeChat();
      if (unsubscribeSettings) unsubscribeSettings();
      if (unsubscribePresence) unsubscribePresence();
      if (presenceInterval) clearInterval(presenceInterval);
      document.getElementById('chat-screen').style.display = 'none';
      document.getElementById('contact-screen').style.display = 'flex';
      currentCollection = null;
    };

    // --- 4. CHAT ENGINE ---
    function loadChat() {
      const q = query(collection(db, currentCollection), orderBy("time", "asc"));
      unsubscribeChat = onSnapshot(q, (snap) => {
        const div = document.getElementById('messages');
        div.innerHTML = ""; 
        snap.forEach(docSnap => {
          const d = docSnap.data();
          if(docSnap.id.startsWith('_')) return; // Skip settings/status docs
          if(!d.time) return;
          if ((new Date() - d.time.toDate())/36e5 > 24) { deleteDoc(doc(db, currentCollection, docSnap.id)); return; }
          if (d.type === 'image') lastImageSent = d.image;
          const isMe = d.sender === currentUserDisplay;
          const tStr = d.time.toDate().getHours() + ":" + String(d.time.toDate().getMinutes()).padStart(2,'0');
          const msgDiv = document.createElement('div');
          msgDiv.className = `msg ${isMe ? 'me' : 'her'}`;
          msgDiv.ondblclick = () => deleteMsg(docSnap.id);
          if (d.type === 'image') {
            msgDiv.innerHTML = `<img src="${d.image}" onload="scrollToBottom()">`;
          } else {
            const contentDiv = document.createElement('div');
            contentDiv.className = 'msg-content';
            contentDiv.textContent = d.text;
            msgDiv.appendChild(contentDiv);
          }
          const timeSpan = document.createElement('span');
          timeSpan.className = 'time';
          timeSpan.textContent = tStr;
          msgDiv.appendChild(timeSpan);
          div.appendChild(msgDiv);
        });
        scrollToBottom(); setTimeout(scrollToBottom, 200);
      });
    }

    // --- 5. REAL PRESENCE ENGINE ---
    function initPresence() {
      // Determine my ID and Partner's ID
      const myStatusDoc = isAdmin ? "_status_host" : "_status_guest";
      const partnerStatusDoc = isAdmin ? "_status_guest" : "_status_host";
      
      // 1. Heartbeat: Update my status every 60s
      const updateHeartbeat = () => {
        setDoc(doc(db, currentCollection, myStatusDoc), { lastSeen: serverTimestamp() });
      };
      updateHeartbeat(); // Call immediately
      presenceInterval = setInterval(updateHeartbeat, 60000);

      // 2. Listener: Watch partner's status
      unsubscribePresence = onSnapshot(doc(db, currentCollection, partnerStatusDoc), (docSnap) => {
        const statusLabel = document.getElementById('chat-status');
        if (docSnap.exists()) {
          const lastSeen = docSnap.data().lastSeen?.toDate();
          if (lastSeen) {
            const diff = (new Date() - lastSeen) / 1000; // seconds
            if (diff < 120) {
               statusLabel.innerText = "online";
               statusLabel.style.color = "#90ee90"; // Light green
            } else {
               statusLabel.innerText = "offline";
               statusLabel.style.color = "rgba(255,255,255,0.7)";
            }
          }
        } else {
          statusLabel.innerText = "offline";
        }
      });
    }

    function loadWallpaper() {
      unsubscribeSettings = onSnapshot(doc(db, currentCollection, "_settings"), (docSnap) => {
        const screen = document.getElementById('chat-screen');
        if (docSnap.exists() && docSnap.data().wallpaper) {
          screen.style.backgroundImage = `url('${docSnap.data().wallpaper}')`;
          screen.classList.add('has-wallpaper');
        } else {
          screen.style.backgroundImage = '';
          screen.classList.remove('has-wallpaper');
        }
      });
    }

    // --- UTILS ---
    window.send = async () => {
      const txt = document.getElementById('txt');
      const val = txt.value.trim();
      if(val && currentCollection) {
        await addDoc(collection(db, currentCollection), { text: val, sender: currentUserDisplay, type: 'text', time: serverTimestamp() });
        txt.value = ""; txt.style.height = '22px'; txt.focus();
      }
    };
    window.handleImageUpload = (input) => {
      const file = input.files[0];
      if (!file) return;
      processImage(file, (base64) => {
        addDoc(collection(db, currentCollection), { image: base64, sender: currentUserDisplay, type: 'image', time: serverTimestamp() });
      });
      input.value = ''; 
    };
    window.handleWallpaperUpload = (input) => {
      const file = input.files[0];
      if(!file) return;
      processImage(file, (base64) => setWallpaper(base64));
      input.value = ''; document.getElementById('wp-modal').style.display = 'none';
    };
    function processImage(file, callback) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.src = e.target.result;
        img.onload = () => {
          const cvs = document.createElement('canvas');
          const ctx = cvs.getContext('2d');
          const sc = 800 / img.width;
          cvs.width = 800; cvs.height = img.height * sc;
          ctx.drawImage(img, 0, 0, cvs.width, cvs.height);
          callback(cvs.toDataURL('image/jpeg', 0.7));
        }
      }
      reader.readAsDataURL(file);
    }
    async function setWallpaper(url) { await setDoc(doc(db, currentCollection, "_settings"), { wallpaper: url }, { merge: true }); }
    window.useLastPhoto = () => { if(lastImageSent) { setWallpaper(lastImageSent); closeWallpaperModal(); } else alert("No photos!"); };
    window.resetWallpaper = async () => { await setDoc(doc(db, currentCollection, "_settings"), { wallpaper: null }, { merge: true }); closeWallpaperModal(); };
    window.openWallpaperModal = () => document.getElementById('wp-modal').style.display = 'flex';
    window.closeWallpaperModal = () => document.getElementById('wp-modal').style.display = 'none';
    window.deleteMsg = async (id) => { if(confirm("Delete?") && currentCollection) await deleteDoc(doc(db, currentCollection, id)); };
    function scrollToBottom() { const div = document.getElementById('messages'); div.scrollTop = div.scrollHeight; }
    
    document.getElementById('pass').addEventListener('keydown', (e) => { if(e.key === 'Enter') attemptLogin(); });
    const txtInput = document.getElementById('txt');
    txtInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); } });
    txtInput.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; if(this.value === '') this.style.height = '22px'; });
  </script>
</body>
</html>
