<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Our Secret Space ‚ù§Ô∏è</title>
  <style>
    /* --- DESIGN & COLORS --- */
    body { margin: 0; background: #ece5dd; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; height: 100vh; display: flex; flex-direction: column; }
    
    /* Login Screen */
    #lock { position: fixed; inset: 0; background: #fff; z-index: 99; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
    input.pass { padding: 15px; font-size: 18px; border-radius: 30px; border: 1px solid #ccc; text-align: center; margin-bottom: 15px; width: 80%; max-width: 300px; outline: none; }
    button.btn { padding: 12px 30px; background: #075e54; color: white; border: none; border-radius: 30px; font-size: 16px; cursor: pointer; font-weight: bold; }
    
    /* Chat Screen */
    #chat-wrap { display: none; flex-direction: column; height: 100%; max-width: 600px; margin: 0 auto; background: #e5ddd5; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
    
    header { background: #075e54; color: white; padding: 10px 20px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; z-index: 10; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .status-text { font-size: 12px; font-weight: normal; opacity: 0.9; display: block; margin-top: 2px;}
    
    #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; scroll-behavior: smooth; }
    
    /* Bubble Styles */
    .msg { padding: 8px 12px; border-radius: 8px; max-width: 75%; font-size: 15px; position: relative; word-wrap: break-word; box-shadow: 0 1px 1px rgba(0,0,0,0.1); line-height: 1.4; cursor: pointer; user-select: none; }
    .msg:hover { opacity: 0.9; }
    .msg.me { align-self: flex-end; background: #dcf8c6; border-top-right-radius: 0; }
    .msg.her { align-self: flex-start; background: #fff; border-top-left-radius: 0; }
    .time { font-size: 10px; color: #999; text-align: right; margin-top: 4px; display: block; }

    /* Image Styles */
    .msg img { max-width: 100%; border-radius: 5px; margin-bottom: 5px; display: block;}

    /* Input Area */
    #input-area { display: flex; padding: 10px; background: #f0f0f0; gap: 10px; align-items: center; }
    #txt { flex: 1; padding: 12px 15px; border-radius: 25px; border: none; outline: none; font-size: 15px; background: white; }
    
    .icon-btn { background: transparent; color: #555; width: 40px; height: 40px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: 0.2s; }
    .icon-btn:hover { background: #ddd; }
    .send-btn { background: #075e54; color: white; }
    .send-btn:hover { background: #064b42; }

    /* Hidden file input */
    #imgInput { display: none; }

  </style>
</head>
<body>

  <!-- LOCK SCREEN -->
  <div id="lock">
    <h2 style="color:#444; margin-bottom:20px;">üîí Restricted Access</h2>
    <p style="color:#666; margin-bottom:20px; font-size: 14px;">Enter your secret pass:</p>
    <input type="password" id="pass" class="pass" placeholder="Password..." autocomplete="off">
    <button class="btn" onclick="attemptLogin()">Enter</button>
    <p id="error" style="color:red; margin-top:10px; opacity:0; font-size:14px;">Wrong password!</p>
  </div>

  <!-- CHAT AREA -->
  <div id="chat-wrap">
    <header>
      <div style="display:flex; align-items:center; gap:10px;">
        <div style="width:40px; height:40px; background:#fff; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#075e54; font-size:18px;">‚ù§Ô∏è</div>
        <div>
           <span id="header-title">Chat</span>
           <span id="status-indicator" class="status-text">Offline</span>
        </div>
      </div>
      <button onclick="location.reload()" style="background:transparent; border:none; color:rgba(255,255,255,0.8); cursor:pointer; font-size:12px;">Logout</button>
    </header>
    
    <div id="messages">
      <!-- Messages appear here -->
    </div>
    
    <div id="input-area">
      <!-- Image Upload Button -->
      <button class="icon-btn" onclick="document.getElementById('imgInput').click()">üì∑</button>
      <input type="file" id="imgInput" accept="image/*" onchange="handleImageUpload(this)">
      
      <input type="text" id="txt" placeholder="Type a message..." autocomplete="off">
      <button class="icon-btn send-btn" onclick="send()">‚û§</button>
    </div>
  </div>

  <!-- FIREBASE ENGINE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, deleteDoc, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // --- CONFIGURATION ---
    const firebaseConfig = {
      apiKey: "AIzaSyDznEmz6rxBJ_2QAgWIoEzWPBpM5QvocRQ",
      authDomain: "our-space-cbc39.firebaseapp.com",
      projectId: "our-space-cbc39",
      storageBucket: "our-space-cbc39.firebasestorage.app",
      messagingSenderId: "930162638208",
      appId: "1:930162638208:web:72cac87408d931efe01565"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // --- PASSWORDS ---
    const PASS_ISHAN = "dumbass";
    const PASS_HER = "bawli";
    
    let currentUser = null; // Will be "Ishan" or "Her"
    let otherUser = null;   // The person we are talking to

    // --- LOGIN LOGIC ---
    window.attemptLogin = () => {
      const p = document.getElementById('pass').value.toLowerCase().trim();
      const lock = document.getElementById('lock');
      
      if (p === PASS_ISHAN) {
        currentUser = "Ishan";
        otherUser = "Her";
      } else if (p === PASS_HER) {
        currentUser = "Her";
        otherUser = "Ishan";
      } else {
        const err = document.getElementById('error');
        err.style.opacity = '1';
        setTimeout(() => err.style.opacity = '0', 2000);
        return;
      }

      document.getElementById('header-title').innerText = otherUser;
      lock.style.opacity = '0';
      setTimeout(() => {
        lock.style.display = 'none';
        document.getElementById('chat-wrap').style.display = 'flex';
        scrollToBottom();
      }, 500);

      loadChat();
      startPresenceSystem();
    };

    // --- SEND MESSAGE ---
    window.send = async () => {
      const txt = document.getElementById('txt');
      const textVal = txt.value.trim();
      
      if(textVal) {
        try {
          await addDoc(collection(db, "chats"), {
            text: textVal,
            sender: currentUser,
            type: 'text',
            time: serverTimestamp()
          });
          txt.value = "";
          txt.focus();
          updateMyStatus(); 
        } catch(e) { console.error(e); }
      }
    };

    // --- IMAGE HANDLING (Resize & Send) ---
    window.handleImageUpload = (input) => {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.src = e.target.result;
        img.onload = function() {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const maxWidth = 800;
          const scaleSize = maxWidth / img.width;
          canvas.width = maxWidth;
          canvas.height = img.height * scaleSize;
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          
          const dataUrl = canvas.toDataURL('image/jpeg', 0.7); 
          
          addDoc(collection(db, "chats"), {
            image: dataUrl,
            sender: currentUser,
            type: 'image',
            time: serverTimestamp()
          });
        }
      }
      reader.readAsDataURL(file);
      input.value = ''; 
    };

    // --- DELETE MESSAGE ---
    window.deleteMsg = async (id) => {
      if(confirm("Delete this message?")) {
        try { await deleteDoc(doc(db, "chats", id)); } catch(e) {}
      }
    };

    // --- PRESENCE SYSTEM (Online/Offline) ---
    function startPresenceSystem() {
      updateMyStatus();
      setInterval(updateMyStatus, 60000);

      onSnapshot(doc(db, "status", otherUser), (docSnap) => {
        if (docSnap.exists()) {
          const lastSeen = docSnap.data().lastSeen.toDate();
          const now = new Date();
          const diff = (now - lastSeen) / 1000; 
          
          const statusSpan = document.getElementById('status-indicator');
          if (diff < 120) { 
            statusSpan.innerText = "Online üü¢";
            statusSpan.style.color = "#cfc";
          } else {
            statusSpan.innerText = "Offline";
            statusSpan.style.color = "rgba(255,255,255,0.7)";
          }
        }
      });
    }

    async function updateMyStatus() {
      try {
        await setDoc(doc(db, "status", currentUser), {
          lastSeen: serverTimestamp()
        });
      } catch(e) { console.log("Status update error", e); }
    }

    // --- LOAD CHAT + AUTO CLEANUP ---
    function loadChat() {
      const q = query(collection(db, "chats"), orderBy("time", "asc"));
      
      onSnapshot(q, (snap) => {
        const div = document.getElementById('messages');
        div.innerHTML = ""; 
        
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const id = docSnap.id;
          
          if(!d.time) return; 

          // --- AUTO NUKE (Delete if > 24 hours old) ---
          const now = new Date();
          const msgTime = d.time.toDate();
          const hoursOld = (now - msgTime) / 1000 / 60 / 60;
          
          if (hoursOld > 24) {
            deleteDoc(doc(db, "chats", id));
            return; // Skip rendering this
          }
          // --------------------------------------------
          
          const isMe = d.sender === currentUser;
          const tStr = msgTime.getHours() + ":" + String(msgTime.getMinutes()).padStart(2,'0');
          
          let content = "";
          if (d.type === 'image') {
             content = `<img src="${d.image}" alt="Image">`;
          } else {
             content = d.text;
          }

          div.innerHTML += `
            <div class="msg ${isMe ? 'me' : 'her'}" ondblclick="deleteMsg('${id}')">
              ${content}
              <span class="time">${tStr}</span>
            </div>`;
        });
        scrollToBottom();
      });
    }

    function scrollToBottom() {
      const div = document.getElementById('messages');
      div.scrollTop = div.scrollHeight;
    }

    document.getElementById('pass').addEventListener('keydown', (e) => {
      if(e.key === 'Enter') attemptLogin();
    });
    document.getElementById('txt').addEventListener('keydown', (e) => {
      if(e.key === 'Enter') send();
    });
  </script>
</body>
</html>
